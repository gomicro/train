project:
  name: train

envs:
  DOCKER_PASSWORD: $DOCKER_PASSWORD
  DOCKER_USERNAME: $DOCKER_USERNAME

steps:
  build:
    help: Build the project
    envs:
      CGO_ENABLED: 0
      GOOS: '{{.Os}}'
    cmd: >
      go build -ldflags
      "-X 'github.com/gomicro/train/cmd.Version=dev-{{.ShortSha}}'
      -X 'github.com/gomicro/train/cmd.clientID=$TRAIN_CLIENT_ID'
      -X 'github.com/gomicro/train/cmd.clientSecret=$TRAIN_CLIENT_SECRET'"
      -o {{.Project}} .
  clean:
    help: Clean up all generated files
    cmds:
      - go clean
      - rm -f coverage.txt
  coverage:
    help: generate coverage
    cmd: docker run -v $PWD:/src gomicro/gocover
  deploy:
    help: deploy the artifacts
    cmds:
      - echo "Logging into Docker Hub"
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - "VERSION={{.ShortSha}} goreleaser release"
  fmt:
    help: Run gofmt
    cmd: go fmt ./...
  linters:
    help: Run all the linters
    steps:
      - lint
      - fmt
      - vet
  lint:
    help: Run golangci-lint
    cmd: golangci-lint run
  install:
    help: Install the binary
    envs:
      CGO_ENABLED: 0
      GOOS: '{{.Os}}'
    cmd: >
      go install -ldflags
      "-X 'github.com/gomicro/train/cmd.Version=dev-{{.ShortSha}}'
      -X 'github.com/gomicro/train/cmd.clientID=$TRAIN_CLIENT_ID'
      -X 'github.com/gomicro/train/cmd.clientSecret=$TRAIN_CLIENT_SECRET'"
  test:
    help: Run all available tests
    steps:
    - unit test
  unit_test:
    help: Run the unit tests
    cmd: go test ./...
  vet:
    help: Run go vet
    cmd: go vet ./...
